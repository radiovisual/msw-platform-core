# mock-platform-core

A reusable, portable mock platform core for frontend and full-stack projects.

## Goals
- Register mock API endpoints with minimal config (just JSON payloads, endpoint, method, status codes, feature flags)
- Generate handlers for MSW, Storybook, Cypress, etc. from a single source of truth
- Provide a UI for toggling feature flags, response codes, and scenarios at runtime
- Make it easy to integrate into any React app, Storybook, or test suite
- Abstract persistence and allow for custom storage

## Architecture Overview
- **Core API**: Register plugins (endpoints), feature flags, and scenarios
- **Adapters**: For MSW, Storybook, Cypress, etc.
- **UI**: Embeddable React component for runtime control
- **Persistence**: Pluggable (localStorage, session, in-memory)

## Example Usage

### 1. Define your plugins and create the platform

```js
import { createMockPlatform } from "mock-platform-core";

const platform = createMockPlatform({
  plugins: [
    {
      id: "user",
      endpoint: "/api/user",
      method: "GET",
      responses: {
        200: { name: "Alice" },
        404: { error: "Not found" },
      },
      defaultStatus: 200,
      featureFlags: ["EXPERIMENTAL_USER"],
    },
  ],
  featureFlags: ["EXPERIMENTAL_USER"],
});
```

### 2. Use with MSW in your app or tests

#### Browser (client-side, e.g. React app or Storybook)

```js
import { setupWorker } from "msw";
import { mswHandlersFromPlatform } from "mock-platform-core";

const worker = setupWorker(...mswHandlersFromPlatform(platform));
worker.start();

// Now all fetches to /api/user will be mocked according to the platform state
```

#### Node.js (server-side, e.g. Jest or Vitest tests)

```js
import { setupServer } from "msw/node";
import { mswHandlersFromPlatform } from "mock-platform-core";

const server = setupServer(...mswHandlersFromPlatform(platform));

beforeAll(() => server.listen());
afterEach(() => server.resetHandlers());
afterAll(() => server.close());
```

### 3. Toggling flags and status at runtime

```js
// Toggle a feature flag
platform.setFeatureFlag("EXPERIMENTAL_USER", true);

// Override the status code for a plugin
platform.setStatusOverride("user", 404);
```

### 4. Example handler (for reference)

Handlers are generated for you, but here's what they look like under the hood:

```js
import { http, HttpResponse } from "msw";

http.get("/api/user", () => {
  // This logic is auto-generated by mswHandlersFromPlatform
  return HttpResponse.json({ name: "Alice" }, { status: 200 });
});
```

## Next Steps
- See `PROJECT_SPEC.md` for file/module structure and development plan. 

---

## Guide: Using mswHandlersFromPlatform in a Real React Application

### 1. Install dependencies

```bash
npm install msw mock-platform-core
```

### 2. Create your mock platform and handlers

```js
// src/mocks/platform.js
import { createMockPlatform } from 'mock-platform-core';

export const platform = createMockPlatform({
  plugins: [
    {
      id: 'user',
      endpoint: '/api/user',
      method: 'GET',
      responses: {
        200: { name: 'Alice' },
        404: { error: 'Not found' },
      },
      defaultStatus: 200,
      featureFlags: ['EXPERIMENTAL_USER'],
    },
    {
      id: 'items',
      endpoint: '/api/items',
      method: 'GET',
      responses: {
        200: [
          { id: '1', name: 'Book' },
          { id: '2', name: 'Pen' },
        ],
      },
      defaultStatus: 200,
    },
  ],
  featureFlags: ['EXPERIMENTAL_USER'],
});
```

```js
// src/mocks/handlers.js
import { mswHandlersFromPlatform } from 'mock-platform-core';
import { platform } from './platform';

export const handlers = mswHandlersFromPlatform(platform);
```

### 3. Set up MSW in the browser

```js
// src/mocks/browser.js
import { setupWorker } from 'msw';
import { handlers } from './handlers';

export const worker = setupWorker(...handlers);
```

### 4. Start the worker before your app renders

```js
// src/index.js
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

if (process.env.NODE_ENV === 'development') {
  const { worker } = require('./mocks/browser');
  worker.start();
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
```

### 5. Use the platform API in your React app

```js
// src/App.js
import React, { useState } from 'react';
import { platform } from './mocks/platform';

export default function App() {
  const [user, setUser] = useState(null);
  const [flag, setFlag] = useState(platform.getFeatureFlags().EXPERIMENTAL_USER);

  const fetchUser = async () => {
    const res = await fetch('/api/user');
    setUser(await res.json());
  };

  const toggleFlag = () => {
    platform.setFeatureFlag('EXPERIMENTAL_USER', !flag);
    setFlag(!flag);
  };

  return (
    <div>
      <h1>Mocked User API Example</h1>
      <button onClick={fetchUser}>Fetch User</button>
      <button onClick={toggleFlag} style={{ marginLeft: 8 }}>
        Toggle EXPERIMENTAL_USER (currently {String(flag)})
      </button>
      <pre>{user && JSON.stringify(user, null, 2)}</pre>
    </div>
  );
}
```

---

### How it works
- All requests to `/api/user` and `/api/items` are intercepted and mocked by MSW using the handlers generated by `mswHandlersFromPlatform`.
- You can toggle feature flags or status codes at runtime using the platform API, and the next request will reflect the new mock state.
- This pattern works for any React app, Storybook, or test suite using MSW v2+ and Node 18+.

--- 

---

## Guide: Integrating with Storybook using storybookHandlersFromPlatform

### 1. Install dependencies

```bash
npm install msw msw-storybook-addon mock-platform-core
```

### 2. Configure Storybook to use MSW

**.storybook/preview.ts**
```ts
import type { Preview } from "@storybook/react";
import { initialize, mswDecorator } from "msw-storybook-addon";

initialize({
  onUnhandledRequest: "bypass",
});

const preview: Preview = {
  parameters: {
    controls: {
      matchers: {
        color: /(background|color)$/i,
        date: /Date$/i,
      },
    },
  },
};

export const decorators = [mswDecorator];
export default preview;
```

**.storybook/main.ts**
```ts
import type { StorybookConfig } from "@storybook/react-webpack5";

const config: StorybookConfig = {
  stories: ["../src/**/*.stories.@(js|jsx|mjs|ts|tsx)"],
  addons: [
    "@storybook/addon-webpack5-compiler-swc",
    "@storybook/addon-essentials",
    "msw-storybook-addon",
  ],
  staticDirs: ["../public"], // ðŸ‘ˆ serve mockServiceWorker.js
  framework: {
    name: "@storybook/react-webpack5",
    options: {},
  },
};
export default config;
```

### 3. Create your platform and handlers

```js
// src/mocks/platform.js
import { createMockPlatform } from 'mock-platform-core';

export const platform = createMockPlatform({
  plugins: [
    {
      id: 'user',
      endpoint: '/api/user',
      method: 'GET',
      responses: {
        200: { name: 'Alice' },
        404: { error: 'Not found' },
      },
      defaultStatus: 200,
      featureFlags: ['EXPERIMENTAL_USER'],
    },
  ],
  featureFlags: ['EXPERIMENTAL_USER'],
});
```

### 4. Use the Storybook adapter in your stories

```js
// src/App.stories.tsx
import React from "react";
import type { Meta, StoryObj } from "@storybook/react";
import { App } from "./App";
import { platform } from "./mocks/platform";
import { storybookHandlersFromPlatform } from "mock-platform-core/src/adapters/storybook";

const meta: Meta<typeof App> = {
  title: "App",
  component: App,
};
export default meta;

type Story = StoryObj<typeof App>;

export const Default: Story = {
  parameters: {
    msw: {
      handlers: storybookHandlersFromPlatform(platform),
    },
  },
};

export const AltMode: Story = {
  parameters: {
    msw: {
      handlers: storybookHandlersFromPlatform(() => {
        platform.setFeatureFlag("EXPERIMENTAL_USER", true);
        return platform;
      }),
    },
  },
};
```

---

### How it works
- The `storybookHandlersFromPlatform` adapter generates MSW handlers for your platform config.
- You can use different platform states per story by passing a function that mutates the platform before returning it.
- This enables powerful, stateful mocking in Storybook, with full support for feature flags, status overrides, and scenarios.

--- 

## Storybook Adapter vs MSW Adapter: What's the Difference?

- **MSW Adapter (`mswHandlersFromPlatform`)**: Generates MSW handlers from your platform config for use in any environment (Node.js, browser, tests, etc.).
- **Storybook Adapter (`storybookHandlersFromPlatform`)**: A semantic alias for the MSW adapter, designed specifically for Storybook integration. It makes your intent clear and matches the expected usage for the `msw` parameter in Storybook stories.
- **Why is this useful?**
  - Keeps your Storybook stories clean and intention-revealing.
  - Allows you to use the same platform config and runtime API as your app/tests, but in a Storybook context.
  - Supports per-story platform state (e.g., toggling flags or status codes for a specific story).
  - Enables powerful, stateful mocking in Storybook, including feature flags, status overrides, and scenarios.

In summary: Use the Storybook adapter in your Storybook stories for clarity and maintainability, and use the MSW adapter everywhere else.

--- 

---

## Proxy Passthrough: Disabling Mocks and Allowing Real Backend/Proxy

Both the MSW and Storybook adapters now support a passthrough feature. You can disable specific mocks by plugin id, and those requests will not be interceptedâ€”they will be passed through to your real backend or proxy (e.g., localhost:4711).

### How to use

#### In your app or tests (Node.js or browser):

```js
import { mswHandlersFromPlatform } from 'mock-platform-core';
import { platform } from './mocks/platform';

const handlers = mswHandlersFromPlatform(platform, {
  disabledPluginIds: ['user'], // disables the 'user' mock, lets it passthrough
});
```

#### In Storybook:

```js
import { storybookHandlersFromPlatform } from 'mock-platform-core/src/adapters/storybook';
import { platform } from './mocks/platform';

export const Default = {
  parameters: {
    msw: {
      handlers: storybookHandlersFromPlatform(platform, {
        disabledPluginIds: ['user'], // disables the 'user' mock
      }),
    },
  },
};
```

### How it works
- When a plugin id is listed in `disabledPluginIds`, requests for that endpoint are not mocked and will be handled by the real backend or proxy (e.g., localhost:4711).
- This is useful for hybrid development, debugging, or when you want to test against real data for some endpoints and mock others.
- You can toggle which mocks are enabled/disabled at runtime (soon via the PopupUI, or programmatically now).

--- 

## Popup Mock UI Widget

The Popup Mock UI widget provides a floating control panel for toggling mock endpoints, feature flags, and groups at runtime. It works seamlessly with the MSW adapter and persists your changes across browser sessions.

### Installation

```
pnpm add msw-mock-platform-core react lucide-react @radix-ui/react-dialog @radix-ui/react-tabs @radix-ui/react-checkbox @radix-ui/react-radio-group @radix-ui/react-label @radix-ui/react-popover
```

### Usage

1. **Register your endpoints and feature flags with the platform:**

```ts
import { createMockPlatform } from 'msw-mock-platform-core'

const platform = createMockPlatform()
// ...register endpoints, feature flags, etc.
```

2. **Add the Popup UI widget to your app:**

```tsx
import MockUI from 'msw-mock-platform-core/src/ui/MockUI'

function App() {
  return (
    <>
      {/* ...your app... */}
      <MockUI platform={platform} />
    </>
  )
}
```

3. **Control your mocks at runtime:**

- Open the floating widget (bottom-right).
- Toggle endpoints on/off, change status codes, manage groups, and enable/disable feature flags.
- Changes are saved to localStorage and persist across reloads.

> **Note:** The widget will show a "Settings coming soon" message for the settings tab. 